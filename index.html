<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>From Payd</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html,body{margin:0;overflow:hidden;background:#000}
canvas{display:block}
#photo{
  position:absolute;
  top:50%;left:50%;
  width:min(260px,70vw);
  transform:translate(-50%,-50%) scale(0.2) rotate(-8deg);
  opacity:0;
  border-radius:20px;
  box-shadow:0 0 60px rgba(255,180,200,0.9);
  transition:2.2s ease;
}
#tap{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  font-size:18px;
  background:rgba(0,0,0,.85);
  z-index:10;
}
</style>
</head>
<body>


<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>

<script>
/* ================= DEVICE ================= */
const isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

/* ================= AUDIO ================= */
const bgm=new Audio("https://cdn.pixabay.com/audio/2023/03/14/audio_42c6a38e9e.mp3");
bgm.loop=true; bgm.volume=0.4;
const boom=new Audio("https://cdn.pixabay.com/audio/2022/03/10/audio_5db7b98b6a.mp3");
boom.volume=0.6;

/* ================= SCENE ================= */
const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,1000);
camera.position.z=isMobile?45:35;

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(devicePixelRatio);
renderer.setClearColor(0x000000);
document.body.appendChild(renderer.domElement);

/* ================= PARTICLES ================= */
const COUNT=isMobile?3200:8000;
const geo=new THREE.BufferGeometry();
const pos=new Float32Array(COUNT*3);
for(let i=0;i<COUNT*3;i++) pos[i]=(Math.random()-0.5)*60;
geo.setAttribute("position",new THREE.BufferAttribute(pos,3));

const mat=new THREE.PointsMaterial({
  color:0xffb6c1,
  size:isMobile?0.12:0.18,
  transparent:true,
  blending:THREE.AdditiveBlending
});
const particles=new THREE.Points(geo,mat);
scene.add(particles);

/* ================= TEXT TO PARTICLES ================= */
function textToPoints(text){
  const scale = isMobile ? 0.75 : 1;

  const c = document.createElement("canvas");
  c.width = innerWidth * 1.4;
  c.height = innerHeight * 0.5;

  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);

  const fontSize = c.width * 0.12 * scale;
  ctx.font = `bold ${fontSize}px Arial`;
  ctx.fillStyle = "white";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";

  ctx.fillText(text, c.width / 2, c.height / 2);

  const d = ctx.getImageData(0,0,c.width,c.height).data;
  const pts = [];

  for(let y=0;y<c.height;y+=6){
    for(let x=0;x<c.width;x+=6){
      if(d[(y*c.width + x)*4] > 200){
        pts.push({
          x:(x - c.width/2) / 18,
          y:(c.height/2 - y) / 18,
          z:(Math.random()-0.5)*2
        });
      }
    }
  }
  return pts;
}


/* ================= MORPH & EXPLODE ================= */
function explode(){
  const p=geo.attributes.position.array;
  for(let i=0;i<COUNT;i++){
    gsap.to(p,{
      [i*3]:p[i*3]+(Math.random()-0.5)*35,
      [i*3+1]:p[i*3+1]+(Math.random()-0.5)*35,
      [i*3+2]:p[i*3+2]+(Math.random()-0.5)*35,
      duration:1,
      ease:"power3.out",
      onUpdate:()=>geo.attributes.position.needsUpdate=true
    });
  }
}

function morph(text){
  const t=textToPoints(text);
  const p=geo.attributes.position.array;
  for(let i=0;i<COUNT;i++){
    const g=t[i%t.length];
    gsap.to(p,{
      [i*3]:g.x,[i*3+1]:g.y,[i*3+2]:g.z,
      duration:2.2,
      ease:"power4.inOut",
      onUpdate:()=>geo.attributes.position.needsUpdate=true
    });
  }
}

/* ================= RADIAL FIREWORKS ================= */
const fireworks=[];
function launchFirework(){
  boom.currentTime=0; boom.play();

  const count = isMobile ? 180 : 260;
  const g=new THREE.BufferGeometry();
  const p=new Float32Array(count*3);
  const v=new Float32Array(count*3);

  for(let i=0;i<count;i++){
    const a=Math.random()*Math.PI*2;
    const s=Math.random()*1.8;
    v[i*3]=Math.cos(a)*s;
    v[i*3+1]=Math.sin(a)*s;
    v[i*3+2]=(Math.random()-0.5)*s;
  }

  g.setAttribute("position",new THREE.BufferAttribute(p,3));
  g.setAttribute("velocity",new THREE.BufferAttribute(v,3));

  const m=new THREE.PointsMaterial({
    color:new THREE.Color().setHSL(Math.random(),1,0.7),
    size:0.35,
    transparent:true,
    blending:THREE.AdditiveBlending
  });

  const f=new THREE.Points(g,m);
  f.position.set((Math.random()-0.5)*20,(Math.random()*10)+5,0);
  f.userData.time=0;
  scene.add(f);
  fireworks.push(f);
}

function updateFireworks(){
  fireworks.forEach((f,i)=>{
    const p=f.geometry.attributes.position.array;
    const v=f.geometry.attributes.velocity.array;
    f.userData.time+=0.03;
    for(let j=0;j<p.length/3;j++){
      p[j*3]+=v[j*3];
      p[j*3+1]+=v[j*3+1]-f.userData.time*0.04;
      p[j*3+2]+=v[j*3+2];
    }
    f.geometry.attributes.position.needsUpdate=true;
    if(f.userData.time>2){
      scene.remove(f); fireworks.splice(i,1);
    }
  });
}

/* ================= INTERACTION ================= */
let drag=false,px=0;
addEventListener("pointerdown",e=>{drag=true;px=e.clientX});
addEventListener("pointerup",()=>drag=false);
addEventListener("pointermove",e=>{
  if(drag){
    camera.rotation.y+=(e.clientX-px)*0.0004;
    px=e.clientX;
  }
});

if(isMobile && window.DeviceOrientationEvent){
  window.addEventListener("deviceorientation",e=>{
    camera.rotation.x=e.beta*0.0005;
    camera.rotation.y=e.gamma*0.0005;
  });
}

/* ================= TIMELINE ================= */
setTimeout(()=>morph("1"),1000);
setTimeout(explode,3500);
setTimeout(()=>morph("2"),4000);
setTimeout(explode,6500);
setTimeout(()=>morph("3"),7000);
setTimeout(explode,9500);
setTimeout(()=>morph("New Year <3"),10000);

setTimeout(()=>{
  const img=document.getElementById("photo");
  img.style.opacity=1;
  img.style.transform="translate(-50%,-50%) scale(1) rotate(0deg)";
},13000);

/* ================= LOOP ================= */
function animate(t){
  requestAnimationFrame(animate);
  camera.position.x=Math.sin(t*0.0003)*1.2;
  updateFireworks();
  renderer.render(scene,camera);
}
animate();
setInterval(launchFirework,isMobile ? 2600 : 1800);


/* ================= START AUDIO ================= */
document.getElementById("auto").onclick=()=>{
  bgm.play();
  document.getElementById("tap").remove();
};

/* ================= RESIZE ================= */
addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
